<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <title>Lorenz Attractor</title>
  <meta name="description" content="Numerical simulations of a Lorenz Attractor in JavaScript">
  <link rel="stylesheet" href="css/ode.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap">
  <link rel="preload" href="css/uplot.min.css" as="style">
  <link rel="preload" href="scripts/ode.js" as="script">
  <link rel="preload" href="scripts/uplot.min.js" as="script">
</head>

<body>
  <h1>Lorenz Attractor</h1>
  <p>This is a <a href="https://en.wikipedia.org/wiki/Lorenz_system">Lorenz strange attractor</a>
    <br>
    I'll add an explanation sometime soon, it was developed to model atmospheric convection or something... It has cool,
    chaotic behaviour, so have fun playing around with it. :D

    <br>
    <br>
    Note to myself:
    <br>
    ADD AN ANIMATED MODE!!! THAT WOULD BE SO COOL!
  </p>

  <div style="display: flex; justify-content: space-between;">
    <div class="sliderscont">
      <input type="range" oninput="updateSim()" min="8" max="16" value="11" name="resolution slider" id="resSlid">
      <label for="resSlid">resolution</label>
      <input type="range" oninput="updateInitialValues()" value="8 / 3" min="0" max="3" step="any" name="amplitude"
        id="betaSlid">
      <label for="betaSlid">beta</label>
    </div>

    <div class="sliderscont">
      <input type="range" oninput="updateInitialValues()" value="5" min="0.1" max="10" step="any"
        name="resonance slider" id="deltaSlid">
      <label for="deltaSlid">delta</label>
      <input type="range" oninput="updateInitialValues()" value="10" min="-20" max="20" step="any"
        name="dampening slider" id="gammaSlid">
      <label for="gammaSlid">initial position</label>
    </div>
  </div>

  <canvas style="width: 100%;" id="canvas"></canvas>
  <div id="plot"></div>
</body>
<link rel="stylesheet" href="css/uplot.min.css">
<script src="scripts/uplot.min.js"></script>
<script src="scripts/ode.js"></script>
<script>
  var delta = 10
  var beta = 8 / 3
  var radius = 28
  var Lorenz = {
    f: (t, y) => {
      return [-delta * (y[0] - y[1]), radius * y[0] - y[1] - y[0] * y[2], -beta * y[2] + y[0] * y[1]]
    },
    parameters: [[0, 1, 0.5], 0, 40]
  }

  function updateInitialValues() {
    beta = parseFloat(document.getElementById("betaSlid").value)
    Lorenz.parameters[0][0] = parseFloat(document.getElementById("gammaSlid").value)
    delta = parseFloat(document.getElementById("deltaSlid").value)
    updateSim()
  }

  setOde(Lorenz)

  function updateSim() {
    u.setData(calcOde(Math.pow(2, document.getElementById("resSlid").value)))
  }

  const opts = {
    width: 900,
    height: 900,
    title: "Lorenz attractor",
    scales: {
      x: { time: false },
    },
    series: [
      { label: "t" },
      {
        label: "x",
        stroke: "#D32F2F",
      },
      {
        label: "y",
        stroke: "#ff8000",
      },
      {
        label: "z",
        stroke: "#12B02F",
      },
    ],
  }

  var canvas = document.getElementById("canvas")
  var ctx = canvas.getContext("2d")
  const map = (value, x1, y1, x2, y2) => (value - x1) * (y2 - x2) / (y1 - x1) + x2;
  function calcOde(resolution) {
    const eres = solver.rk4(~~resolution)
    data = [
      eres.ts,
      eres.ys.map((t) => t[0]),
      eres.ys.map((t) => t[1]),
      eres.ys.map((t) => t[2]),
    ]

    xmin = Math.min(...data[1])
    xmax = Math.max(...data[1])
    ymin = Math.min(...data[2])
    ymax = Math.max(...data[2])
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    ctx.beginPath()
    for (let i = 0; i < data[1].length; i++) {
      const x = data[1][i]
      ctx.lineTo(
        map(x, xmin, xmax, 0, canvas.width),
        map(data[2][i], ymin, ymax, 0, canvas.height))
    }
    ctx.stroke()
    return data
  }


  canvas.height = plotElem.clientWidth
  canvas.width = plotElem.clientWidth
  var u = new uPlot(opts, calcOde(2 ** 11), plotElem)
  u.setSize({ width: plotElem.clientWidth, height: plotElem.clientWidth });
  window.addEventListener("resize", e => {
    u.setSize({ width: plotElem.clientWidth, height: plotElem.clientWidth });
    canvas.height = plotElem.clientWidth
    canvas.width = plotElem.clientWidth
  })
</script>
<script defer src='https://static.cloudflareinsights.com/beacon.min.js'
  data-cf-beacon='{"token": "f9f51233f11041a194c4d5f4511d8282"}'></script>

</html>